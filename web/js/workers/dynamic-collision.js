(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
/* entity worker */
// collisions btween entities in motion and other entities
"use strict";

var distance2d = function (a, b) {

  return Math.sqrt(Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2));
},
    distance2dCompare = function (a, b, n) {
  // more efficient version of distance2d()

  return Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2) < n * n;
},
    distance3dCompare = function (a, b, n) {
  // ..faster than using Math.sqrt()

  return Math.pow(a[0] - b[0], 2) + Math.pow(a[1] - b[1], 2) + Math.pow(a[2] - b[2], 2) < n * n;
};

var voxelList = [],
    voxels = {},
    // map of string coordinates to arrays of entities
observer = {
  position: [0, 0, 0],
  prevPos: [0, 0, 0],
  velocity: [0, 0, 0],
  hands: [],
  vrHeight: 0
};

self.onmessage = function (event) {
  // probably going to replace most of this worker with Cannon.js.. & can fallback to static-collision worker in most cases

  var message = JSON.parse(event.data),
      data = message.data,
      entities = [],
      voxel = null,
      user = observer,
      c = 0;

  if (message.command == "set in motion") {} else if (message.command == "become static") {} else if (message.command == "add voxels") {

    voxelList = voxelList.concat(data);

    data.map(function (v) {

      voxels[v.cell.join(".")] = v;
    });
  } else if (message.command == "remove voxels") {

    c = data.length - 1;

    while (c >= 0) {

      toRemove = data[c];
      voxelList.splice(voxelList.indexOf(voxels[toRemove.cell]), 1);
      voxels[toRemove.cell] = null;
      c--;
    }
  } else if (message.command == "add entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      voxels[data.coords.join("x")].entities.push(data.entity);
    }
  } else if (message.command == "remove entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      c = entities.length - 1;

      while (c >= 0) {

        if (entities[c].id == data.entityId) {

          voxels[data.coords.join(".")].entities.splice(c, 1);
          c = -1;
        }

        c--;
      }
    }
  } else if (message.command == "update entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      c = entities.length - 1;

      while (c >= 0) {

        if (entities[c].id == data.entityId) {

          entities[c] = data.entity;
          c = -1;
        }

        c--;
      }
    }
  } else if (message.command == "update") {

    user.position = data.position;
    user.velocity = data.velocity;
    user.vrHeight = data.vrHeight;
  } else if (message.command == "start") {

    self.update();
  } else if (message.command == "stop") {

    self.stop();
  }
};

self.stop = function () {
  clearTimeout(self.updateLoop);
};

self.update = function () {

  var entities = [],
      user = observer,
      position = user.position,
      secondPos = null,
      coords = [Math.floor(position[0] / 928000), 0, Math.floor(position[2] / 807360)],
      key = "",
      obj = null,
      secondObj = null,
      x = -1,
      z = -1,
      i = 0,
      o = 0;

  while (x <= 2) {
    // only simulate entities in 9 voxels around the user

    while (z <= 2) {

      key = x + coords[0] + ".0." + (z + coords[2]);

      if (voxels[key] != null) {

        entities = voxels[key].entities;

        if (!!entities) {

          i = entities.length;

          while (i >= 0) {

            obj = entities[i];

            if (!!obj && !!obj.moving) {
              //moving) {

              o = entities.length - 1; // if moving, check collisions against all other entities (in that voxel)

              while (o >= 0) {

                secondObj = entities[o];
                secondPos = secondObj.position;

                if (distance3dCompare(secondPos, obj.position, obj.boundingRadius + secondObj.boundingRadius)) {
                  // look up the proper radius
                  // send back the new position and velocity for both entities
                  self.postMessage("{\"command\": \"entity-entity collision\", \"data\":{\"entities\":[{\"position\":[" + obj.position[0] + "," + obj.position[1] + "," + obj.position[2] + "],\"velocity\": [0, 0, 0] }, {\"position\":[" + secondPos[0] + "," + secondPos[1] + "," + secondPos[2] + "],\"velocity\": [0, 0, 0] }]}}");
                }

                o--;
              }
            }

            i--;
          }
        }
      }

      ++z;
    }

    ++x;
  }

  self.postMessage("{\"command\": \"update\"}");
  self.updateLoop = setTimeout(function () {
    self.update();
  }, 15);
};

// implement

// implement

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJDOi9Db2RlL3NyYy9naXRodWIuY29tL1NwYWNlSGV4YWdvbi9jb252b2x2ci9jbGllbnQvc3JjL2pzL3dvcmtlcnMvZHluYW1pYy1jb2xsaXNpb25zLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQ0VBLElBQUksVUFBVSxHQUFHLFVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBTTs7QUFFekIsU0FBTyxJQUFJLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxHQUFHLENBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRyxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFFLENBQUUsQ0FBQTtDQUUzRTtJQUNELGlCQUFpQixHQUFHLFVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQU07OztBQUVsQyxTQUFPLElBQUksQ0FBQyxHQUFHLENBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRyxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFFLEdBQUksQ0FBQyxHQUFDLENBQUMsQUFBQyxDQUFBO0NBRXRFO0lBQ0QsaUJBQWlCLEdBQUcsVUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBTTs7O0FBRWxDLFNBQU8sQUFBQyxJQUFJLENBQUMsR0FBRyxDQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBRyxDQUFDLENBQUMsQ0FB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QUVGOztBQUVELFFBQUcsQ0FBQyxDQUFBO0tBRUw7O0FBRUQsTUFBRyxDQUFDLENBQUE7R0FFTDs7QUFFRCxNQUFJLENBQUMsV0FBVyxDQUFDLDJCQUF1QixDQUFDLENBQUE7QUFDMUMsTUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUUsWUFBTTtBQUNuQyxRQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7R0FDYixFQUFFLEVBQUUsQ0FBQyxDQUFBO0NBRU4sQ0FBQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCIvKiBlbnRpdHkgd29ya2VyICovXHJcbi8vIGNvbGxpc2lvbnMgYnR3ZWVuIGVudGl0aWVzIGluIG1vdGlvbiBhbmQgb3RoZXIgZW50aXRpZXNcclxubGV0IGRpc3RhbmNlMmQgPSAoIGEsIGIgKSA9PiB7XHJcblxyXG4gICAgcmV0dXJuIE1hdGguc3FydCggTWF0aC5wb3coKGFbMF0tYlswXSksIDIgKSArIE1hdGgucG93KCAoYVsyXS1iWzJdKSwgMiApIClcclxuXHJcbiAgfSxcclxuICBkaXN0YW5jZTJkQ29tcGFyZSA9ICggYSwgYiwgbiApID0+IHsgLy8gbW9yZSBlZmZpY2llbnQgdmVyc2lvbiBvZiBkaXN0YW5jZTJkKClcclxuXHJcblx0ICByZXR1cm4gTWF0aC5wb3coIChhWzBdLWJbMF0pLCAyICkgKyBNYXRoLnBvdyggKGFbMl0tYlsyXSksIDIgKSA8IChuKm4pXHJcblxyXG4gIH0sXHJcbiAgZGlzdGFuY2UzZENvbXBhcmUgPSAoIGEsIGIsIG4gKSA9PiB7IC8vIC4uZmFzdGVyIHRoYW4gdXNpbmcgTWF0aC5zcXJ0KClcclxuXHJcblx0ICByZXR1cm4gKE1hdGgucG93KCAoYVswXS1iWzBdKSwgMiApICsgTWF0aC5wb3coIChhWzFdLWJbMV0pLCAyICkgKyBNYXRoLnBvdyggKGFbMl0tYlsyXSksIDIgKSkgPCAobipuKVxyXG5cclxuICB9XHJcblxyXG5sZXQgdm94ZWxMaXN0ID0gW10sXHJcblx0ICB2b3hlbHMgPSB7fSwgLy8gbWFwIG9mIHN0cmluZyBjb29yZGluYXRlcyB0byBhcnJheXMgb2YgZW50aXRpZXNcclxuICAgIG9ic2VydmVyID0ge1xyXG4gIFx0XHRwb3NpdGlvbjogWzAsIDAsIDBdLFxyXG4gIFx0XHRwcmV2UG9zOiBbMCwgMCwgMF0sXHJcbiAgXHRcdHZlbG9jaXR5OiBbMCwgMCwgMF0sXHJcbiAgICAgIGhhbmRzOiBbXSxcclxuICBcdFx0dnJIZWlnaHQ6IDBcclxuICBcdH1cclxuXHJcbnNlbGYub25tZXNzYWdlID0gZXZlbnQgPT4geyAvLyBwcm9iYWJseSBnb2luZyB0byByZXBsYWNlIG1vc3Qgb2YgdGhpcyB3b3JrZXIgd2l0aCBDYW5ub24uanMuLiAmIGNhbiBmYWxsYmFjayB0byBzdGF0aWMtY29sbGlzaW9uIHdvcmtlciBpbiBtb3N0IGNhc2VzIFxyXG5cclxuXHRsZXQgbWVzc2FnZSA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YSksXHJcblx0XHRcdGRhdGEgPSBtZXNzYWdlLmRhdGEsXHJcbiAgICAgIGVudGl0aWVzID0gW10sXHJcbiAgICAgIHZveGVsID0gbnVsbCxcclxuICAgICAgdXNlciA9IG9ic2VydmVyLFxyXG5cdFx0XHRjID0gMFxyXG5cclxuICBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInNldCBpbiBtb3Rpb25cIiApIHtcclxuICAgIC8vIGltcGxlbWVudFxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJiZWNvbWUgc3RhdGljXCIgKSB7XHJcbiAgICAvLyBpbXBsZW1lbnRcclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwiYWRkIHZveGVsc1wiICkge1xyXG5cclxuICAgIHZveGVsTGlzdCA9IHZveGVsTGlzdC5jb25jYXQoZGF0YSlcclxuXHJcblx0XHRkYXRhLm1hcCggdiA9PiB7XHJcbiAgICAgIFxyXG5cdFx0XHR2b3hlbHNbIHYuY2VsbC5qb2luKFwiLlwiKSBdID0gdlxyXG5cclxuXHRcdH0pXHJcblxyXG4gIH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInJlbW92ZSB2b3hlbHNcIiApIHtcclxuXHJcbiAgICBjID0gZGF0YS5sZW5ndGggLTFcclxuXHJcblx0XHR3aGlsZSAoIGMgPj0gMCApIHtcclxuXHJcblx0XHRcdHRvUmVtb3ZlID0gZGF0YVsgYyBdXHJcbiAgICAgIHZveGVsTGlzdC5zcGxpY2UoIHZveGVsTGlzdC5pbmRleE9mKHZveGVsc1sgdG9SZW1vdmUuY2VsbCBdKSAsIDEgKVxyXG4gICAgICB2b3hlbHNbIHRvUmVtb3ZlLmNlbGwgXSA9IG51bGxcclxuXHRcdFx0YyAtLVxyXG5cclxuXHRcdH1cclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwiYWRkIGVudGl0eVwiICkge1xyXG5cclxuICAgIGVudGl0aWVzID0gdm94ZWxzW2RhdGEuY29vcmRzLmpvaW4oXCIuXCIpXS5lbnRpdGllc1xyXG5cclxuICAgIGlmIChlbnRpdGllcyAhPSBudWxsKSB7XHJcblxyXG4gICAgICB2b3hlbHNbIGRhdGEuY29vcmRzLmpvaW4oXCJ4XCIpIF0uZW50aXRpZXMucHVzaChkYXRhLmVudGl0eSlcclxuXHJcbiAgICB9XHJcblxyXG4gIH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInJlbW92ZSBlbnRpdHlcIiApIHtcclxuXHJcbiAgICBlbnRpdGllcyA9IHZveGVsc1tkYXRhLmNvb3Jkcy5qb2luKFwiLlwiKV0uZW50aXRpZXNcclxuXHJcbiAgICBpZiAoIGVudGl0aWVzICE9IG51bGwgKSB7XHJcblxyXG4gICAgICBjID0gZW50aXRpZXMubGVuZ3RoLTFcclxuXHJcbiAgXHRcdHdoaWxlICggYyA+PSAwICkge1xyXG5cclxuICBcdFx0XHRpZiAoIGVudGl0aWVzWyBjIF0uaWQgPT0gZGF0YS5lbnRpdHlJZCApIHtcclxuXHJcbiAgXHRcdFx0XHR2b3hlbHNbZGF0YS5jb29yZHMuam9pbihcIi5cIildLmVudGl0aWVzLnNwbGljZSggYywgMSApXHJcbiAgICAgICAgICBjID0gLTFcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICBcdFx0XHRjLS1cclxuXHJcbiAgXHRcdH1cclxuXHJcbiAgICB9XHJcblxyXG4gIH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInVwZGF0ZSBlbnRpdHlcIiApIHtcclxuXHJcblx0XHRlbnRpdGllcyA9IHZveGVsc1sgZGF0YS5jb29yZHMuam9pbihcIi5cIikgXS5lbnRpdGllc1xyXG5cclxuXHRcdGlmICggZW50aXRpZXMgIT0gbnVsbCApIHtcclxuXHJcblx0XHRcdGMgPSBlbnRpdGllcy5sZW5ndGgtMVxyXG5cclxuXHRcdFx0d2hpbGUgKCBjID49IDAgKSB7XHJcblxyXG5cdFx0XHRcdGlmICggZW50aXRpZXNbIGMgXS5pZCA9PSBkYXRhLmVudGl0eUlkICkge1xyXG5cclxuXHRcdFx0XHRcdGVudGl0aWVzWyBjIF0gPSBkYXRhLmVudGl0eVxyXG5cdFx0XHRcdFx0YyA9IC0xXHJcblxyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0Yy0tXHJcblxyXG5cdFx0XHR9XHJcblxyXG5cdFx0fVxyXG5cclxuXHR9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJ1cGRhdGVcIiApIHtcclxuXHJcbiAgICB1c2VyLnBvc2l0aW9uID0gZGF0YS5wb3NpdGlvblxyXG5cdFx0dXNlci52ZWxvY2l0eSA9IGRhdGEudmVsb2NpdHlcclxuXHRcdHVzZXIudnJIZWlnaHQgPSBkYXRhLnZySGVpZ2h0XHJcblxyXG4gIH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcInN0YXJ0XCIgKSB7XHJcblxyXG5cdFx0c2VsZi51cGRhdGUoKVxyXG5cclxuXHR9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJzdG9wXCIgKSB7XHJcblxyXG5cdFx0c2VsZi5zdG9wKClcclxuXHJcbiAgfVxyXG59O1xyXG5cclxuc2VsZi5zdG9wID0gKCkgPT4ge1xyXG5cdGNsZWFyVGltZW91dChzZWxmLnVwZGF0ZUxvb3ApO1xyXG59XHJcblxyXG5zZWxmLnVwZGF0ZSA9ICgpID0+IHtcclxuXHJcbiAgbGV0IGVudGl0aWVzID0gW10sXHJcbiAgICAgIHVzZXIgPSBvYnNlcnZlcixcclxuICAgICAgcG9zaXRpb24gPSB1c2VyLnBvc2l0aW9uLFxyXG4gICAgICBzZWNvbmRQb3MgPSBudWxsLFxyXG4gICAgICBjb29yZHMgPSBbTWF0aC5mbG9vcihwb3NpdGlvblswXS85MjgwMDApLCAwLCBNYXRoLmZsb29yKHBvc2l0aW9uWzJdLzgwNzM2MCldLFxyXG4gICAgICBrZXkgPSAnJyxcclxuICAgICAgb2JqID0gbnVsbCxcclxuICAgICAgc2Vjb25kT2JqID0gbnVsbCxcclxuICAgICAgeCA9IC0gMSxcclxuICAgICAgeiA9IC0gMSxcclxuICAgICAgaSA9IDAsXHJcbiAgICAgIG8gPSAwXHJcblxyXG4gIHdoaWxlICggeCA8PSAyICkgeyAvLyBvbmx5IHNpbXVsYXRlIGVudGl0aWVzIGluIDkgdm94ZWxzIGFyb3VuZCB0aGUgdXNlclxyXG5cclxuICAgIHdoaWxlICggeiA8PSAyICkge1xyXG5cclxuICAgICAga2V5ID0gKHgrY29vcmRzWzBdKSsnLjAuJysoeitjb29yZHNbMl0pXHJcblxyXG4gICAgICBpZiAoIHZveGVsc1trZXldICE9IG51bGwgKSB7XHJcblxyXG4gICAgICAgIGVudGl0aWVzID0gdm94ZWxzW2tleV0uZW50aXRpZXNcclxuXHJcbiAgICAgICAgaWYgKCAhIWVudGl0aWVzICkge1xyXG5cclxuICAgICAgICAgIGkgPSBlbnRpdGllcy5sZW5ndGhcclxuXHJcbiAgICAgICAgICB3aGlsZSAoIGkgPj0gMCApIHtcclxuXHJcbiAgICAgICAgICAgIG9iaiA9IGVudGl0aWVzW2ldXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZiAoICEhb2JqICYmICEhIG9iai5tb3ZpbmcgKSB7IC8vbW92aW5nKSB7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICBvID0gZW50aXRpZXMubGVuZ3RoIC0xIC8vIGlmIG1vdmluZywgY2hlY2sgY29sbGlzaW9ucyBhZ2FpbnN0IGFsbCBvdGhlciBlbnRpdGllcyAoaW4gdGhhdCB2b3hlbClcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgd2hpbGUgKG8gPj0gMCkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgc2Vjb25kT2JqID0gZW50aXRpZXNbb11cclxuICAgICAgICAgICAgICAgICAgc2Vjb25kUG9zID0gc2Vjb25kT2JqLnBvc2l0aW9uXHJcblxyXG4gICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UzZENvbXBhcmUoc2Vjb25kUG9zLCBvYmoucG9zaXRpb24sIG9iai5ib3VuZGluZ1JhZGl1cytzZWNvbmRPYmouYm91bmRpbmdSYWRpdXMpKSB7IC8vIGxvb2sgdXAgdGhlIHByb3BlciByYWRpdXNcclxuICAgICAgICAgICAgICAgICAgICAvLyBzZW5kIGJhY2sgdGhlIG5ldyBwb3NpdGlvbiBhbmQgdmVsb2NpdHkgZm9yIGJvdGggZW50aXRpZXNcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKCd7XCJjb21tYW5kXCI6IFwiZW50aXR5LWVudGl0eSBjb2xsaXNpb25cIiwgXCJkYXRhXCI6e1wiZW50aXRpZXNcIjpbe1wicG9zaXRpb25cIjpbJytvYmoucG9zaXRpb25bMF0gKyAnLCcgKyBvYmoucG9zaXRpb25bMV0gKyAnLCcgKyBvYmoucG9zaXRpb25bMl0gKyAnXSxcInZlbG9jaXR5XCI6IFswLCAwLCAwXSB9LCB7XCJwb3NpdGlvblwiOlsnK3NlY29uZFBvc1swXSArICcsJyArIHNlY29uZFBvc1sxXSArICcsJyArIHNlY29uZFBvc1syXSArICddLFwidmVsb2NpdHlcIjogWzAsIDAsIDBdIH1dfX0nKVxyXG5cclxuICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgbyAtLVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGkgLS1cclxuXHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgIH1cclxuXHJcbiAgICAgICsrIHpcclxuXHJcbiAgICB9XHJcblxyXG4gICAgKysgeFxyXG5cclxuICB9XHJcblxyXG4gIHNlbGYucG9zdE1lc3NhZ2UoJ3tcImNvbW1hbmRcIjogXCJ1cGRhdGVcIn0nKVxyXG5cdHNlbGYudXBkYXRlTG9vcCA9IHNldFRpbWVvdXQoICgpID0+IHtcclxuXHRcdHNlbGYudXBkYXRlKClcclxuXHR9LCAxNSlcclxuXHJcbn1cclxuIl19
