(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
/* entity worker */
// collisions btween entities in motion and other entities
"use strict";

var distance2d = function (a, b) {

  return Math.sqrt(Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2));
},
    distance2dCompare = function (a, b, n) {
  // more efficient version of distance2d()

  return Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2) < n * n;
},
    distance3dCompare = function (a, b, n) {
  // ..faster than using Math.sqrt()

  return Math.pow(a[0] - b[0], 2) + Math.pow(a[1] - b[1], 2) + Math.pow(a[2] - b[2], 2) < n * n;
};

var voxels = {},
    // map of string coordinates to arrays of entities
observer = {
  position: [0, 0, 0],
  prevPos: [0, 0, 0],
  velocity: [0, 0, 0],
  hands: [],
  vrHeight: 0
};

self.onmessage = function (event) {
  // Do some work.
  var message = JSON.parse(event.data),
      data = message.data,
      entities = [],
      voxel = null,
      user = observer,
      c = 0;

  if (message.command == "set in motion") {} else if (message.command == "become static") {} else if (message.command == "add voxels") {

    data.map(function (voxel) {

      voxels[voxel.cell.join(".")] = voxel;
    });
  } else if (message.command == "remove voxels") {

    p = data.length - 1;

    while (p >= 0) {

      toRemove = data[p];
      voxels[toRemove.cell] = null;
      p--;
    }
  } else if (message.command == "add entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      voxels[data.coords.join("x")].entities.push(data.entity);
    }
  } else if (message.command == "remove entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      c = entities.length - 1;

      while (c >= 0) {

        if (entities[c].id == data.entityId) {

          voxels[data.coords.join(".")].entities.splice(c, 1);
          c = -1;
        }

        c--;
      }
    }
  } else if (message.command == "update") {

    user.position = data.position;
    user.velocity = data.velocity;
    user.vrHeight = data.vrHeight;
  } else if (message.command == "start") {

    self.update();
  } else if (message.command == "stop") {

    self.stop();
  }
};

self.stop = function () {
  clearTimeout(self.updateLoop);
};

self.update = function () {

  var entities = [],
      user = observer,
      position = user.position,
      secondPos = null,
      coords = [Math.floor(position[0] / 928000), 0, Math.floor(position[2] / 807360)],
      key = "",
      obj = null,
      secondObj = null,
      x = -1,
      z = -1,
      i = 0,
      o = 0;

  while (x <= 2) {
    // only simulate entities in 9 voxels around the user

    while (z <= 2) {

      key = x + coords[0] + ".0." + (z + coords[2]);

      if (voxels[key] != null) {

        entities = voxels[key].entities;

        if (!!entities) {

          i = entities.length;

          while (i >= 0) {

            obj = entities[i];

            if (!!obj) {

              if (!!obj.moving) {
                //moving) {

                o = entities.length - 1; // if moving, check collisions against all other entities (in that voxel)

                while (o >= 0) {

                  secondObj = entities[o];
                  secondPos = secondObj.position;

                  if (distance3dCompare(secondPos, obj.position, obj.boundingRadius + secondObj.boundingRadius)) {
                    // look up the proper radius
                    // send back the new position and velocity for both entities
                    self.postMessage("{\"command\": \"entity-entity collision\", \"data\":{\"entities\":[{\"position\":[" + obj.position[0] + "," + obj.position[1] + "," + obj.position[2] + "],\"velocity\": [0, 0, 0] }, {\"position\":[" + secondPos[0] + "," + secondPos[1] + "," + secondPos[2] + "],\"velocity\": [0, 0, 0] }]}}");
                  }

                  o--;
                }
              }
            }

            i--;
          }
        }
      }

      ++z;
    }

    ++x;
  }

  self.postMessage("{\"command\": \"update\"}");
  self.updateLoop = setTimeout(function () {
    self.update();
  }, 15);
};

// implement

// implement

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJDOi9Db2RlL3NyYy9naXRodWIuY29tL1NwYWNlSGV4YWdvbi9jb252b2x2ci9jbGllbnQvc3JjL2pzL3dvcmtlcnMvZHluYW1pYy1jb2xsaXNpb25zLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQ0VBLElBQUksVUFBVSxHQUFHLFVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBTTs7QUFFekIsU0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtDQUV0RTtJQUNELGlCQUFpQixHQUFHLFVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUs7OztBQUVoQyxTQUFPLElBQUksQ0FBQyxHQUFHLENBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRyxDQUFDLENBQUMsR0FBQyxJQUFJLENBQUMsR0FBRyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFDLEdBQUksQ0FBQyxHQUFDLENBQUMsQUFBQyxDQUFBO0NBRWhFO0lBQ0QsaUJBQWlCLEdBQUcsVUFBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBSzs7O0FBRWhDLFNBQU8sQUFBQyxJQUFJLENBQUMsR0FBRyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBRSxDQUFDLENBQUMsQ0FB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QUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsOENBQTBDLEdBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxnQ0FBOEIsQ0FBQyxDQUFBO21CQUVsUzs7QUFFRCxtQkFBQyxFQUFHLENBQUE7aUJBRUw7ZUFFRjthQUVGOztBQUVELGFBQUMsRUFBRyxDQUFBO1dBRUw7U0FFRjtPQUVGOztBQUVELFFBQUcsQ0FBQyxDQUFBO0tBRUw7O0FBRUQsTUFBRyxDQUFDLENBQUE7R0FFTDs7QUFFRCxNQUFJLENBQUMsV0FBVyxDQUFDLDJCQUF1QixDQUFDLENBQUE7QUFDMUMsTUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUUsWUFBTTtBQUNuQyxRQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7R0FDYixFQUFFLEVBQUUsQ0FBQyxDQUFBO0NBRU4sQ0FBQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCIvKiBlbnRpdHkgd29ya2VyICovXHJcbi8vIGNvbGxpc2lvbnMgYnR3ZWVuIGVudGl0aWVzIGluIG1vdGlvbiBhbmQgb3RoZXIgZW50aXRpZXNcclxubGV0IGRpc3RhbmNlMmQgPSAoIGEsIGIgKSA9PiB7XHJcblxyXG4gICAgcmV0dXJuIE1hdGguc3FydChNYXRoLnBvdygoYVswXS1iWzBdKSwgMikgKyBNYXRoLnBvdygoYVsyXS1iWzJdKSwgMikpXHJcblxyXG4gIH0sXHJcbiAgZGlzdGFuY2UyZENvbXBhcmUgPSAoYSwgYiwgbikgPT4geyAvLyBtb3JlIGVmZmljaWVudCB2ZXJzaW9uIG9mIGRpc3RhbmNlMmQoKVxyXG5cclxuXHQgIHJldHVybiBNYXRoLnBvdygoYVswXS1iWzBdKSwgMikrTWF0aC5wb3coKGFbMl0tYlsyXSksIDIpIDwgKG4qbilcclxuXHJcbiAgfSxcclxuICBkaXN0YW5jZTNkQ29tcGFyZSA9IChhLCBiLCBuKSA9PiB7IC8vIC4uZmFzdGVyIHRoYW4gdXNpbmcgTWF0aC5zcXJ0KClcclxuXHJcblx0ICByZXR1cm4gKE1hdGgucG93KChhWzBdLWJbMF0pLCAyKSArIE1hdGgucG93KChhWzFdLWJbMV0pLCAyKSArIE1hdGgucG93KChhWzJdLWJbMl0pLCAyKSkgPCAobipuKVxyXG5cclxuICB9XHJcblxyXG5sZXQgdm94ZWxzID0ge30sIC8vIG1hcCBvZiBzdHJpbmcgY29vcmRpbmF0ZXMgdG8gYXJyYXlzIG9mIGVudGl0aWVzXHJcbiAgICBvYnNlcnZlciA9IHtcclxuICBcdFx0cG9zaXRpb246IFswLCAwLCAwXSxcclxuICBcdFx0cHJldlBvczogWzAsIDAsIDBdLFxyXG4gIFx0XHR2ZWxvY2l0eTogWzAsIDAsIDBdLFxyXG4gICAgICBoYW5kczogW10sXHJcbiAgXHRcdHZySGVpZ2h0OiAwXHJcbiAgXHR9XHJcblxyXG5zZWxmLm9ubWVzc2FnZSA9IGV2ZW50ID0+IHsgLy8gRG8gc29tZSB3b3JrLlxyXG5cdGxldCBtZXNzYWdlID0gSlNPTi5wYXJzZShldmVudC5kYXRhKSxcclxuXHRcdFx0ZGF0YSA9IG1lc3NhZ2UuZGF0YSxcclxuICAgICAgZW50aXRpZXMgPSBbXSxcclxuICAgICAgdm94ZWwgPSBudWxsLFxyXG4gICAgICB1c2VyID0gb2JzZXJ2ZXIsXHJcblx0XHRcdGMgPSAwXHJcblxyXG4gIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwic2V0IGluIG1vdGlvblwiICkge1xyXG4gICAgLy8gaW1wbGVtZW50XHJcblxyXG4gIH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcImJlY29tZSBzdGF0aWNcIiApIHtcclxuICAgIC8vIGltcGxlbWVudFxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJhZGQgdm94ZWxzXCIgKSB7XHJcblxyXG4gICAgZGF0YS5tYXAoIHZveGVsID0+IHtcclxuXHJcbiAgICAgIHZveGVsc1sgdm94ZWwuY2VsbC5qb2luKFwiLlwiKSBdID0gdm94ZWxcclxuXHJcbiAgICB9KVxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJyZW1vdmUgdm94ZWxzXCIgKSB7XHJcblxyXG4gICAgcCA9IGRhdGEubGVuZ3RoIC0xXHJcblxyXG5cdFx0d2hpbGUgKCBwID49IDAgKSB7XHJcblxyXG5cdFx0XHR0b1JlbW92ZSA9IGRhdGFbIHAgXVxyXG5cdFx0XHR2b3hlbHNbIHRvUmVtb3ZlLmNlbGwgXSA9IG51bGxcclxuXHRcdFx0cCAtLVxyXG5cclxuXHRcdH1cclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwiYWRkIGVudGl0eVwiICkge1xyXG5cclxuICAgIGVudGl0aWVzID0gdm94ZWxzW2RhdGEuY29vcmRzLmpvaW4oXCIuXCIpXS5lbnRpdGllc1xyXG5cclxuICAgIGlmIChlbnRpdGllcyAhPSBudWxsKSB7XHJcblxyXG4gICAgICB2b3hlbHNbZGF0YS5jb29yZHMuam9pbihcInhcIildLmVudGl0aWVzLnB1c2goZGF0YS5lbnRpdHkpXHJcblxyXG4gICAgfVxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJyZW1vdmUgZW50aXR5XCIgKSB7XHJcblxyXG4gICAgZW50aXRpZXMgPSB2b3hlbHNbZGF0YS5jb29yZHMuam9pbihcIi5cIildLmVudGl0aWVzXHJcblxyXG4gICAgaWYgKGVudGl0aWVzICE9IG51bGwpIHtcclxuXHJcbiAgICAgIGMgPSBlbnRpdGllcy5sZW5ndGgtMVxyXG5cclxuICBcdFx0d2hpbGUgKCBjID49IDAgKSB7XHJcblxyXG4gIFx0XHRcdGlmIChlbnRpdGllc1tjXS5pZCA9PSBkYXRhLmVudGl0eUlkKSB7XHJcblxyXG4gIFx0XHRcdFx0dm94ZWxzW2RhdGEuY29vcmRzLmpvaW4oXCIuXCIpXS5lbnRpdGllcy5zcGxpY2UoYywgMSlcclxuICAgICAgICAgIGMgPSAtMVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gIFx0XHRcdGMtLVxyXG5cclxuICBcdFx0fVxyXG5cclxuICAgIH1cclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwidXBkYXRlXCIgKSB7XHJcblxyXG4gICAgdXNlci5wb3NpdGlvbiA9IGRhdGEucG9zaXRpb25cclxuXHRcdHVzZXIudmVsb2NpdHkgPSBkYXRhLnZlbG9jaXR5XHJcblx0XHR1c2VyLnZySGVpZ2h0ID0gZGF0YS52ckhlaWdodFxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJzdGFydFwiICkge1xyXG5cclxuXHRcdHNlbGYudXBkYXRlKClcclxuXHJcblx0fSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwic3RvcFwiICkge1xyXG5cclxuXHRcdHNlbGYuc3RvcCgpXHJcblxyXG4gIH1cclxufTtcclxuXHJcbnNlbGYuc3RvcCA9ICgpID0+IHtcclxuXHRjbGVhclRpbWVvdXQoc2VsZi51cGRhdGVMb29wKTtcclxufVxyXG5cclxuc2VsZi51cGRhdGUgPSAoKSA9PiB7XHJcblxyXG4gIGxldCBlbnRpdGllcyA9IFtdLFxyXG4gICAgICB1c2VyID0gb2JzZXJ2ZXIsXHJcbiAgICAgIHBvc2l0aW9uID0gdXNlci5wb3NpdGlvbixcclxuICAgICAgc2Vjb25kUG9zID0gbnVsbCxcclxuICAgICAgY29vcmRzID0gW01hdGguZmxvb3IocG9zaXRpb25bMF0vOTI4MDAwKSwgMCwgTWF0aC5mbG9vcihwb3NpdGlvblsyXS84MDczNjApXSxcclxuICAgICAga2V5ID0gJycsXHJcbiAgICAgIG9iaiA9IG51bGwsXHJcbiAgICAgIHNlY29uZE9iaiA9IG51bGwsXHJcbiAgICAgIHggPSAtIDEsXHJcbiAgICAgIHogPSAtIDEsXHJcbiAgICAgIGkgPSAwLFxyXG4gICAgICBvID0gMFxyXG5cclxuICB3aGlsZSAoeCA8PSAyKSB7IC8vIG9ubHkgc2ltdWxhdGUgZW50aXRpZXMgaW4gOSB2b3hlbHMgYXJvdW5kIHRoZSB1c2VyXHJcblxyXG4gICAgd2hpbGUgKHogPD0gMikge1xyXG5cclxuICAgICAga2V5ID0gKHgrY29vcmRzWzBdKSsnLjAuJysoeitjb29yZHNbMl0pXHJcblxyXG4gICAgICBpZiAodm94ZWxzW2tleV0gIT0gbnVsbCkge1xyXG5cclxuICAgICAgICBlbnRpdGllcyA9IHZveGVsc1trZXldLmVudGl0aWVzXHJcblxyXG4gICAgICAgIGlmICghIWVudGl0aWVzKSB7XHJcblxyXG4gICAgICAgICAgaSA9IGVudGl0aWVzLmxlbmd0aFxyXG5cclxuICAgICAgICAgIHdoaWxlIChpID49IDApIHtcclxuXHJcbiAgICAgICAgICAgIG9iaiA9IGVudGl0aWVzW2ldXHJcblxyXG4gICAgICAgICAgICBpZiAoISFvYmopIHtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgaWYgKCEhIG9iai5tb3ZpbmcpIHsgLy9tb3ZpbmcpIHtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgbyA9IGVudGl0aWVzLmxlbmd0aCAtMSAvLyBpZiBtb3ZpbmcsIGNoZWNrIGNvbGxpc2lvbnMgYWdhaW5zdCBhbGwgb3RoZXIgZW50aXRpZXMgKGluIHRoYXQgdm94ZWwpXHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHdoaWxlIChvID49IDApIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgIHNlY29uZE9iaiA9IGVudGl0aWVzW29dXHJcbiAgICAgICAgICAgICAgICAgIHNlY29uZFBvcyA9IHNlY29uZE9iai5wb3NpdGlvblxyXG5cclxuICAgICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlM2RDb21wYXJlKHNlY29uZFBvcywgb2JqLnBvc2l0aW9uLCBvYmouYm91bmRpbmdSYWRpdXMrc2Vjb25kT2JqLmJvdW5kaW5nUmFkaXVzKSkgeyAvLyBsb29rIHVwIHRoZSBwcm9wZXIgcmFkaXVzXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBiYWNrIHRoZSBuZXcgcG9zaXRpb24gYW5kIHZlbG9jaXR5IGZvciBib3RoIGVudGl0aWVzXHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSgne1wiY29tbWFuZFwiOiBcImVudGl0eS1lbnRpdHkgY29sbGlzaW9uXCIsIFwiZGF0YVwiOntcImVudGl0aWVzXCI6W3tcInBvc2l0aW9uXCI6Wycrb2JqLnBvc2l0aW9uWzBdICsgJywnICsgb2JqLnBvc2l0aW9uWzFdICsgJywnICsgb2JqLnBvc2l0aW9uWzJdICsgJ10sXCJ2ZWxvY2l0eVwiOiBbMCwgMCwgMF0gfSwge1wicG9zaXRpb25cIjpbJytzZWNvbmRQb3NbMF0gKyAnLCcgKyBzZWNvbmRQb3NbMV0gKyAnLCcgKyBzZWNvbmRQb3NbMl0gKyAnXSxcInZlbG9jaXR5XCI6IFswLCAwLCAwXSB9XX19JylcclxuXHJcbiAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgIG8gLS1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGkgLS1cclxuXHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgIH1cclxuXHJcbiAgICAgICsrIHpcclxuXHJcbiAgICB9XHJcblxyXG4gICAgKysgeFxyXG5cclxuICB9XHJcblxyXG4gIHNlbGYucG9zdE1lc3NhZ2UoJ3tcImNvbW1hbmRcIjogXCJ1cGRhdGVcIn0nKVxyXG5cdHNlbGYudXBkYXRlTG9vcCA9IHNldFRpbWVvdXQoICgpID0+IHtcclxuXHRcdHNlbGYudXBkYXRlKClcclxuXHR9LCAxNSlcclxuXHJcbn1cclxuIl19
