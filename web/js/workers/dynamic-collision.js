(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
/* entity worker */
// collisions btween entities in motion and other entities
"use strict";

var distance2d = function (a, b) {

  return Math.sqrt(Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2));
},
    distance2dCompare = function (a, b, n) {
  // more efficient version of distance2d()

  return Math.pow(a[0] - b[0], 2) + Math.pow(a[2] - b[2], 2) < n * n;
},
    distance3dCompare = function (a, b, n) {
  // ..faster than using Math.sqrt()

  return Math.pow(a[0] - b[0], 2) + Math.pow(a[1] - b[1], 2) + Math.pow(a[2] - b[2], 2) < n * n;
};

var voxelList = [],
    voxels = {},
    // map of string coordinates to arrays of entities
observer = {
  position: [0, 0, 0],
  prevPos: [0, 0, 0],
  velocity: [0, 0, 0],
  hands: [],
  vrHeight: 0
};

self.onmessage = function (event) {
  // probably going to replace most of this worker with Cannon.js.. & can fallback to static-collision worker in most cases

  var message = JSON.parse(event.data),
      data = message.data,
      entities = [],
      toRemove = null,
      voxel = null,
      user = observer,
      c = 0;

  if (message.command == "set in motion") {} else if (message.command == "become static") {} else if (message.command == "add voxels") {

    voxelList = voxelList.concat(data);

    data.map(function (v) {

      voxels[v.cell.join(".")] = v;
    });
  } else if (message.command == "remove voxels") {

    c = data.length - 1;

    while (c >= 0) {

      toRemove = data[c];
      voxelList.splice(voxelList.indexOf(voxels[toRemove.cell]), 1);
      voxels[toRemove.cell] = null;
      c--;
    }
  } else if (message.command == "add entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      voxels[data.coords.join("x")].entities.push(data.entity);
    }
  } else if (message.command == "remove entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      c = entities.length - 1;

      while (c >= 0) {

        if (entities[c].id == data.entityId) {

          voxels[data.coords.join(".")].entities.splice(c, 1);
          c = -1;
        }

        c--;
      }
    }
  } else if (message.command == "update entity") {

    entities = voxels[data.coords.join(".")].entities;

    if (entities != null) {

      c = entities.length - 1;

      while (c >= 0) {

        if (entities[c].id == data.entityId) {

          entities[c] = data.entity;
          c = -1;
        }

        c--;
      }
    }
  } else if (message.command == "update") {

    user.position = data.position;
    user.velocity = data.velocity;
    user.vrHeight = data.vrHeight;
  } else if (message.command == "start") {

    self.update();
  } else if (message.command == "stop") {

    self.stop();
  }
};

self.stop = function () {
  clearTimeout(self.updateLoop);
};

self.update = function () {

  var entities = [],
      user = observer,
      position = user.position,
      secondPos = null,
      coords = [Math.floor(position[0] / 928000), 0, Math.floor(position[2] / 807360)],
      key = "",
      obj = null,
      secondObj = null,
      x = -1,
      z = -1,
      i = 0,
      o = 0;

  while (x <= 2) {
    // only simulate entities in 9 voxels around the user

    while (z <= 2) {

      key = x + coords[0] + ".0." + (z + coords[2]);

      if (voxels[key] != null) {

        entities = voxels[key].entities;

        if (!!entities) {

          i = entities.length;

          while (i >= 0) {

            obj = entities[i];

            if (!!obj && !!obj.moving) {
              //moving) {

              o = entities.length - 1; // if moving, check collisions against all other entities (in that voxel)

              while (o >= 0) {

                secondObj = entities[o];
                secondPos = secondObj.position;

                if (distance3dCompare(secondPos, obj.position, obj.boundingRadius + secondObj.boundingRadius)) {
                  // look up the proper radius
                  // send back the new position and velocity for both entities
                  self.postMessage("{\"command\": \"entity-entity collision\", \"data\":{\"entities\":[{\"position\":[" + obj.position[0] + "," + obj.position[1] + "," + obj.position[2] + "],\"velocity\": [0, 0, 0] }, {\"position\":[" + secondPos[0] + "," + secondPos[1] + "," + secondPos[2] + "],\"velocity\": [0, 0, 0] }]}}");
                }

                o--;
              }
            }

            i--;
          }
        }
      }

      ++z;
    }

    ++x;
  }

  self.postMessage("{\"command\": \"update\"}");
  self.updateLoop = setTimeout(function () {
    self.update();
  }, 15);
};

// implement

// implement

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJDOi9Db2RlL3NyYy9naXRodWIuY29tL1NwYWNlSGV4YWdvbi9jb252b2x2ci9jbGllbnQvc3JjL2pzL3dvcmtlcnMvZHluYW1pYy1jb2xsaXNpb25zLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQ0VBLElBQUksVUFBVSxHQUFHLFVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBTTs7QUFFekIsU0FBTyxJQUFJLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxHQUFHLENBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRyxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFFLENBQUUsQ0FBQTtDQUUzRTtJQUNELGlCQUFpQixHQUFHLFVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQU07OztBQUVsQyxTQUFPLElBQUksQ0FBQyxHQUFHLENBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRyxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFFLEdBQUksQ0FBQyxHQUFDLENBQUMsQUFBQyxDQUFBO0NBRXRFO0lBQ0QsaUJBQWlCLEdBQUcsVUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBTTs7O0FBRWxDLFNBQU8sQUFBQyxJQUFJLENBQUMsR0FBRyxDQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQyxDQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBRyxDQUFDLENBQUMsQ0FB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QUFHLENBQUE7V0FFTDtTQUVGO09BRUY7O0FBRUQsUUFBRyxDQUFDLENBQUE7S0FFTDs7QUFFRCxNQUFHLENBQUMsQ0FBQTtHQUVMOztBQUVELE1BQUksQ0FBQyxXQUFXLENBQUMsMkJBQXVCLENBQUMsQ0FBQTtBQUMxQyxNQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBRSxZQUFNO0FBQ25DLFFBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtHQUNiLEVBQUUsRUFBRSxDQUFDLENBQUE7Q0FFTixDQUFBIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3ZhciBmPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIik7dGhyb3cgZi5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGZ9dmFyIGw9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGwuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sbCxsLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsIi8qIGVudGl0eSB3b3JrZXIgKi9cclxuLy8gY29sbGlzaW9ucyBidHdlZW4gZW50aXRpZXMgaW4gbW90aW9uIGFuZCBvdGhlciBlbnRpdGllc1xyXG5sZXQgZGlzdGFuY2UyZCA9ICggYSwgYiApID0+IHtcclxuXHJcbiAgICByZXR1cm4gTWF0aC5zcXJ0KCBNYXRoLnBvdygoYVswXS1iWzBdKSwgMiApICsgTWF0aC5wb3coIChhWzJdLWJbMl0pLCAyICkgKVxyXG5cclxuICB9LFxyXG4gIGRpc3RhbmNlMmRDb21wYXJlID0gKCBhLCBiLCBuICkgPT4geyAvLyBtb3JlIGVmZmljaWVudCB2ZXJzaW9uIG9mIGRpc3RhbmNlMmQoKVxyXG5cclxuXHQgIHJldHVybiBNYXRoLnBvdyggKGFbMF0tYlswXSksIDIgKSArIE1hdGgucG93KCAoYVsyXS1iWzJdKSwgMiApIDwgKG4qbilcclxuXHJcbiAgfSxcclxuICBkaXN0YW5jZTNkQ29tcGFyZSA9ICggYSwgYiwgbiApID0+IHsgLy8gLi5mYXN0ZXIgdGhhbiB1c2luZyBNYXRoLnNxcnQoKVxyXG5cclxuXHQgIHJldHVybiAoTWF0aC5wb3coIChhWzBdLWJbMF0pLCAyICkgKyBNYXRoLnBvdyggKGFbMV0tYlsxXSksIDIgKSArIE1hdGgucG93KCAoYVsyXS1iWzJdKSwgMiApKSA8IChuKm4pXHJcblxyXG4gIH1cclxuXHJcbmxldCB2b3hlbExpc3QgPSBbXSxcclxuXHQgIHZveGVscyA9IHt9LCAvLyBtYXAgb2Ygc3RyaW5nIGNvb3JkaW5hdGVzIHRvIGFycmF5cyBvZiBlbnRpdGllc1xyXG4gICAgb2JzZXJ2ZXIgPSB7XHJcbiAgXHRcdHBvc2l0aW9uOiBbMCwgMCwgMF0sXHJcbiAgXHRcdHByZXZQb3M6IFswLCAwLCAwXSxcclxuICBcdFx0dmVsb2NpdHk6IFswLCAwLCAwXSxcclxuICAgICAgaGFuZHM6IFtdLFxyXG4gIFx0XHR2ckhlaWdodDogMFxyXG4gIFx0fVxyXG5cclxuc2VsZi5vbm1lc3NhZ2UgPSBldmVudCA9PiB7IC8vIHByb2JhYmx5IGdvaW5nIHRvIHJlcGxhY2UgbW9zdCBvZiB0aGlzIHdvcmtlciB3aXRoIENhbm5vbi5qcy4uICYgY2FuIGZhbGxiYWNrIHRvIHN0YXRpYy1jb2xsaXNpb24gd29ya2VyIGluIG1vc3QgY2FzZXMgXHJcblxyXG5cdGxldCBtZXNzYWdlID0gSlNPTi5wYXJzZShldmVudC5kYXRhKSxcclxuXHRcdFx0ZGF0YSA9IG1lc3NhZ2UuZGF0YSxcclxuICAgICAgZW50aXRpZXMgPSBbXSxcclxuICAgICAgdG9SZW1vdmUgPSBudWxsLFxyXG4gICAgICB2b3hlbCA9IG51bGwsXHJcbiAgICAgIHVzZXIgPSBvYnNlcnZlcixcclxuXHRcdFx0YyA9IDBcclxuXHJcbiAgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJzZXQgaW4gbW90aW9uXCIgKSB7XHJcbiAgICAvLyBpbXBsZW1lbnRcclxuXHJcbiAgfSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwiYmVjb21lIHN0YXRpY1wiICkge1xyXG4gICAgLy8gaW1wbGVtZW50XHJcblxyXG4gIH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcImFkZCB2b3hlbHNcIiApIHtcclxuXHJcbiAgICB2b3hlbExpc3QgPSB2b3hlbExpc3QuY29uY2F0KGRhdGEpXHJcblxyXG5cdFx0ZGF0YS5tYXAoIHYgPT4ge1xyXG4gICAgICBcclxuXHRcdFx0dm94ZWxzWyB2LmNlbGwuam9pbihcIi5cIikgXSA9IHZcclxuXHJcblx0XHR9KVxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJyZW1vdmUgdm94ZWxzXCIgKSB7XHJcblxyXG4gICAgYyA9IGRhdGEubGVuZ3RoIC0xXHJcblxyXG5cdFx0d2hpbGUgKCBjID49IDAgKSB7XHJcblxyXG5cdFx0XHR0b1JlbW92ZSA9IGRhdGFbIGMgXVxyXG4gICAgICB2b3hlbExpc3Quc3BsaWNlKCB2b3hlbExpc3QuaW5kZXhPZih2b3hlbHNbIHRvUmVtb3ZlLmNlbGwgXSkgLCAxIClcclxuICAgICAgdm94ZWxzWyB0b1JlbW92ZS5jZWxsIF0gPSBudWxsXHJcblx0XHRcdGMgLS1cclxuXHJcblx0XHR9XHJcblxyXG4gIH0gZWxzZSBpZiAoIG1lc3NhZ2UuY29tbWFuZCA9PSBcImFkZCBlbnRpdHlcIiApIHtcclxuXHJcbiAgICBlbnRpdGllcyA9IHZveGVsc1tkYXRhLmNvb3Jkcy5qb2luKFwiLlwiKV0uZW50aXRpZXNcclxuXHJcbiAgICBpZiAoZW50aXRpZXMgIT0gbnVsbCkge1xyXG5cclxuICAgICAgdm94ZWxzWyBkYXRhLmNvb3Jkcy5qb2luKFwieFwiKSBdLmVudGl0aWVzLnB1c2goZGF0YS5lbnRpdHkpXHJcblxyXG4gICAgfVxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJyZW1vdmUgZW50aXR5XCIgKSB7XHJcblxyXG4gICAgZW50aXRpZXMgPSB2b3hlbHNbZGF0YS5jb29yZHMuam9pbihcIi5cIildLmVudGl0aWVzXHJcblxyXG4gICAgaWYgKCBlbnRpdGllcyAhPSBudWxsICkge1xyXG5cclxuICAgICAgYyA9IGVudGl0aWVzLmxlbmd0aC0xXHJcblxyXG4gIFx0XHR3aGlsZSAoIGMgPj0gMCApIHtcclxuXHJcbiAgXHRcdFx0aWYgKCBlbnRpdGllc1sgYyBdLmlkID09IGRhdGEuZW50aXR5SWQgKSB7XHJcblxyXG4gIFx0XHRcdFx0dm94ZWxzW2RhdGEuY29vcmRzLmpvaW4oXCIuXCIpXS5lbnRpdGllcy5zcGxpY2UoIGMsIDEgKVxyXG4gICAgICAgICAgYyA9IC0xXHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgXHRcdFx0Yy0tXHJcblxyXG4gIFx0XHR9XHJcblxyXG4gICAgfVxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJ1cGRhdGUgZW50aXR5XCIgKSB7XHJcblxyXG5cdFx0ZW50aXRpZXMgPSB2b3hlbHNbIGRhdGEuY29vcmRzLmpvaW4oXCIuXCIpIF0uZW50aXRpZXNcclxuXHJcblx0XHRpZiAoIGVudGl0aWVzICE9IG51bGwgKSB7XHJcblxyXG5cdFx0XHRjID0gZW50aXRpZXMubGVuZ3RoLTFcclxuXHJcblx0XHRcdHdoaWxlICggYyA+PSAwICkge1xyXG5cclxuXHRcdFx0XHRpZiAoIGVudGl0aWVzWyBjIF0uaWQgPT0gZGF0YS5lbnRpdHlJZCApIHtcclxuXHJcblx0XHRcdFx0XHRlbnRpdGllc1sgYyBdID0gZGF0YS5lbnRpdHlcclxuXHRcdFx0XHRcdGMgPSAtMVxyXG5cclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGMtLVxyXG5cclxuXHRcdFx0fVxyXG5cclxuXHRcdH1cclxuXHJcblx0fSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwidXBkYXRlXCIgKSB7XHJcblxyXG4gICAgdXNlci5wb3NpdGlvbiA9IGRhdGEucG9zaXRpb25cclxuXHRcdHVzZXIudmVsb2NpdHkgPSBkYXRhLnZlbG9jaXR5XHJcblx0XHR1c2VyLnZySGVpZ2h0ID0gZGF0YS52ckhlaWdodFxyXG5cclxuICB9IGVsc2UgaWYgKCBtZXNzYWdlLmNvbW1hbmQgPT0gXCJzdGFydFwiICkge1xyXG5cclxuXHRcdHNlbGYudXBkYXRlKClcclxuXHJcblx0fSBlbHNlIGlmICggbWVzc2FnZS5jb21tYW5kID09IFwic3RvcFwiICkge1xyXG5cclxuXHRcdHNlbGYuc3RvcCgpXHJcblxyXG4gIH1cclxufTtcclxuXHJcbnNlbGYuc3RvcCA9ICgpID0+IHtcclxuXHRjbGVhclRpbWVvdXQoc2VsZi51cGRhdGVMb29wKTtcclxufVxyXG5cclxuc2VsZi51cGRhdGUgPSAoKSA9PiB7XHJcblxyXG4gIGxldCBlbnRpdGllcyA9IFtdLFxyXG4gICAgICB1c2VyID0gb2JzZXJ2ZXIsXHJcbiAgICAgIHBvc2l0aW9uID0gdXNlci5wb3NpdGlvbixcclxuICAgICAgc2Vjb25kUG9zID0gbnVsbCxcclxuICAgICAgY29vcmRzID0gW01hdGguZmxvb3IocG9zaXRpb25bMF0vOTI4MDAwKSwgMCwgTWF0aC5mbG9vcihwb3NpdGlvblsyXS84MDczNjApXSxcclxuICAgICAga2V5ID0gJycsXHJcbiAgICAgIG9iaiA9IG51bGwsXHJcbiAgICAgIHNlY29uZE9iaiA9IG51bGwsXHJcbiAgICAgIHggPSAtIDEsXHJcbiAgICAgIHogPSAtIDEsXHJcbiAgICAgIGkgPSAwLFxyXG4gICAgICBvID0gMFxyXG5cclxuICB3aGlsZSAoIHggPD0gMiApIHsgLy8gb25seSBzaW11bGF0ZSBlbnRpdGllcyBpbiA5IHZveGVscyBhcm91bmQgdGhlIHVzZXJcclxuXHJcbiAgICB3aGlsZSAoIHogPD0gMiApIHtcclxuXHJcbiAgICAgIGtleSA9ICh4K2Nvb3Jkc1swXSkrJy4wLicrKHorY29vcmRzWzJdKVxyXG5cclxuICAgICAgaWYgKCB2b3hlbHNba2V5XSAhPSBudWxsICkge1xyXG5cclxuICAgICAgICBlbnRpdGllcyA9IHZveGVsc1trZXldLmVudGl0aWVzXHJcblxyXG4gICAgICAgIGlmICggISFlbnRpdGllcyApIHtcclxuXHJcbiAgICAgICAgICBpID0gZW50aXRpZXMubGVuZ3RoXHJcblxyXG4gICAgICAgICAgd2hpbGUgKCBpID49IDAgKSB7XHJcblxyXG4gICAgICAgICAgICBvYmogPSBlbnRpdGllc1tpXVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKCAhIW9iaiAmJiAhISBvYmoubW92aW5nICkgeyAvL21vdmluZykge1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgbyA9IGVudGl0aWVzLmxlbmd0aCAtMSAvLyBpZiBtb3ZpbmcsIGNoZWNrIGNvbGxpc2lvbnMgYWdhaW5zdCBhbGwgb3RoZXIgZW50aXRpZXMgKGluIHRoYXQgdm94ZWwpXHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHdoaWxlICggbyA+PSAwICkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgc2Vjb25kT2JqID0gZW50aXRpZXNbb11cclxuICAgICAgICAgICAgICAgICAgc2Vjb25kUG9zID0gc2Vjb25kT2JqLnBvc2l0aW9uXHJcblxyXG4gICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UzZENvbXBhcmUoc2Vjb25kUG9zLCBvYmoucG9zaXRpb24sIG9iai5ib3VuZGluZ1JhZGl1cytzZWNvbmRPYmouYm91bmRpbmdSYWRpdXMpKSB7IC8vIGxvb2sgdXAgdGhlIHByb3BlciByYWRpdXNcclxuICAgICAgICAgICAgICAgICAgICAvLyBzZW5kIGJhY2sgdGhlIG5ldyBwb3NpdGlvbiBhbmQgdmVsb2NpdHkgZm9yIGJvdGggZW50aXRpZXNcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKCd7XCJjb21tYW5kXCI6IFwiZW50aXR5LWVudGl0eSBjb2xsaXNpb25cIiwgXCJkYXRhXCI6e1wiZW50aXRpZXNcIjpbe1wicG9zaXRpb25cIjpbJytvYmoucG9zaXRpb25bMF0gKyAnLCcgKyBvYmoucG9zaXRpb25bMV0gKyAnLCcgKyBvYmoucG9zaXRpb25bMl0gKyAnXSxcInZlbG9jaXR5XCI6IFswLCAwLCAwXSB9LCB7XCJwb3NpdGlvblwiOlsnK3NlY29uZFBvc1swXSArICcsJyArIHNlY29uZFBvc1sxXSArICcsJyArIHNlY29uZFBvc1syXSArICddLFwidmVsb2NpdHlcIjogWzAsIDAsIDBdIH1dfX0nKVxyXG5cclxuICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgbyAtLVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGkgLS1cclxuXHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgIH1cclxuXHJcbiAgICAgICsrIHpcclxuXHJcbiAgICB9XHJcblxyXG4gICAgKysgeFxyXG5cclxuICB9XHJcblxyXG4gIHNlbGYucG9zdE1lc3NhZ2UoJ3tcImNvbW1hbmRcIjogXCJ1cGRhdGVcIn0nKVxyXG5cdHNlbGYudXBkYXRlTG9vcCA9IHNldFRpbWVvdXQoICgpID0+IHtcclxuXHRcdHNlbGYudXBkYXRlKClcclxuXHR9LCAxNSlcclxuXHJcbn1cclxuIl19
